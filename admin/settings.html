<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Admin Dashboard</title>
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="dashboard">
        <aside class="sidebar">
            <div class="sidebar-header"><div class="sidebar-logo"><i class="fas fa-crown"></i> Admin Panel</div></div>
            <nav class="sidebar-menu">
                <a href="dashboard.html" class="menu-item"><i class="fas fa-th-large"></i><span>Dashboard</span></a>
                <a href="blogs.html" class="menu-item"><i class="fas fa-blog"></i><span>Blog Posts</span></a>
                <a href="projects.html" class="menu-item"><i class="fas fa-briefcase"></i><span>Projects</span></a>
                <a href="contacts.html" class="menu-item"><i class="fas fa-envelope"></i><span>Contact Messages</span></a>
                <a href="content.html" class="menu-item"><i class="fas fa-edit"></i><span>Website Content</span></a>
                <a href="settings.html" class="menu-item active"><i class="fas fa-cog"></i><span>Settings</span></a>
            </nav>
        </aside>

        <main class="main-content">
            <div class="top-bar">
                <h1 class="page-title">Settings</h1>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <span id="userName">Admin</span>
                    <button class="btn btn-sm btn-secondary" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 1.5rem;">Profile Settings</h2>
                <form id="profileForm">
                    <div class="form-group">
                        <label for="name">Full Name</label>
                        <input type="text" id="name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Update Profile</button>
                    <div id="profileMessage" class="message" style="margin-top: 1rem;"></div>
                </form>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 1.5rem;">Change Password</h2>
                <form id="passwordForm">
                    <div class="form-group">
                        <label for="currentPassword">Current Password</label>
                        <input type="password" id="currentPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="newPassword">New Password</label>
                        <input type="password" id="newPassword" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm New Password</label>
                        <input type="password" id="confirmPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Change Password</button>
                    <div id="passwordMessage" class="message" style="margin-top: 1rem;"></div>
                </form>
            </div>
        </main>
    </div>

    <script src="js/auth.js"></script>
    <script>
        requireAuth();
        const user = getUser();
        if (user) {
            document.getElementById('userName').textContent = user.name;
            document.getElementById('userAvatar').textContent = user.name.charAt(0).toUpperCase();
            document.getElementById('name').value = user.name;
            document.getElementById('email').value = user.email;
        }

        // Load full user data
        async function loadUserData() {
            try {
                const response = await fetchWithAuth('/auth/me');
                const data = await response.json();
                if (data.success) {
                    const userData = data.data;
                    document.getElementById('name').value = userData.name;
                    document.getElementById('email').value = userData.email;
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Update profile
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
            
            try {
                const response = await fetchWithAuth('/auth/update-profile', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: document.getElementById('name').value,
                        email: document.getElementById('email').value
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showMessage('Profile updated successfully', 'success', 'profileMessage');
                    localStorage.setItem('user', JSON.stringify(data.data));
                } else {
                    showMessage(data.message || 'Error updating profile', 'error', 'profileMessage');
                }
            } catch (error) {
                showMessage('Error updating profile', 'error', 'profileMessage');
            }
            btn.disabled = false;
            btn.innerHTML = 'Update Profile';
        });

        // Change password
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmPassword').value;
            
            if (newPass !== confirmPass) {
                showMessage('Passwords do not match', 'error', 'passwordMessage');
                return;
            }
            
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing...';
            
            try {
                const response = await fetchWithAuth('/auth/change-password', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        currentPassword: document.getElementById('currentPassword').value,
                        newPassword: newPass
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showMessage('Password changed successfully', 'success', 'passwordMessage');
                    e.target.reset();
                } else {
                    showMessage(data.message || 'Error changing password', 'error', 'passwordMessage');
                }
            } catch (error) {
                showMessage('Error changing password', 'error', 'passwordMessage');
            }
            btn.disabled = false;
            btn.innerHTML = 'Change Password';
        });

        function showMessage(msg, type, id) {
            const el = document.getElementById(id);
            el.textContent = msg;
            el.className = `message ${type}`;
            el.style.display = 'block';
        }

        loadUserData();
    </script>
</body>
</html>

